@model Store.Data.DataDbContext.Setting
@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_Cu.cshtml";

}

<link href="~/Content/Chatcss.css" rel="stylesheet" />
<link href="~/fonts/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
@*$('#displayname').val(prompt('Enter your name:', ''));*@
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->

    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script type="text/javascript">
    function createCookie(t, e, n) {
        if (n) {
            var i = new Date;
            i.setTime(i.getTime() + 24 * n * 60 * 60 * 1e3);
            o = "; expires=" + i.toGMTString()
        } else var o = "";
        document.cookie = t + "=" + e + o + "; path=/"
    }

    function readCookie(t) {
        for (var e = t + "=", n = document.cookie.split(";"), i = 0; i < n.length; i++) {
            for (var o = n[i];
    			" " == o.charAt(0);) o = o.substring(1, o.length);
            if (0 == o.indexOf(e)) return o.substring(e.length, o.length)
        }
        return null
    }

    function deleteCookie(t) {
        document.cookie = t + "=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"
    }

    function startChartHub() {
        var t = $.connection.chatHub;
        t.client.broadcastMessage = function (t, e, n) {
            if (checfocus != 1) {
                countmess++;
                $('.count_messagere').html(countmess);
                $('.count_messagere').show();
            } else
                $('.count_messagere').hide();
            idagent = n, $(".name_supporter")
                .text()
                .trim() != t && $("#chatlog")
                .append('<div class="border join_chat_tab"><span  style="color:#16a8df"> ' + t + " đã tham gia đoạn hội thoại </span></div>"), $(".name_supporter")
                .html(t), createCookie("name_sp" + Urlweb, t, .005), $(".button_chat_offline_text")
                .html("Chat với chúng tôi !"), $(".text_supporter")
                .html("Sẵn sàng hỗ trợ");
            if (boolaudio==0)
            new Audio("/Content/Sound/Sound.mp3").play();
            try {
                "none" != $(".start_text_chat")
                    .css("display") && $("#chatlog")
                    .append('<div class="border nameytextchat"><span  style="color:#16a8df"> ' + t + "</span></div>"), -1 != $("#chatlog > div:last-child ")
                    .attr("class")
                    .indexOf("itextchat") && $("#chatlog")
                    .append('<div class="border nameytextchat"><span  style="color:#16a8df"> ' + t + "</span></div>")
            } catch (t) {}
            $("#chatlog")
                .append('<div class="border ytextchat"><span  style="color:#294358"> ' + e + "</span></div>");
            try {
                var i = $(".subiz_conversionin.scroll")[0].scrollHeight;
                $(".subiz_conversion")
                    .scrollTop(i)
            } catch (t) {}
            $(".start_text_chat")
                .hide()
        }, t.client.tranferagen = function (t) {
            $("#chatlog")
                .append('<div class="border join_chat_tab"><span  style="color:#16a8df">  hội thoại đã được chuyển cho' + t + "  </span></div>"), $(".name_supporter")
                .html(t)
        }, t.client.updatereconnect = function (t) {
            0 != $(".leave_chat_tab")
                .length && $(".name_supporter")
                .text()
                .trim() == t && $("#chatlog")
                .append('<div class="border leave_chat_tab"><span  style="color:#16a8df"> ' + t + " đã kết nối lại </span></div>");
            try {
                var e = $(".subiz_conversionin.scroll")[0].scrollHeight;
                $(".subiz_conversion")
                    .scrollTop(e)
            } catch (t) {}
        }, t.client.agentoffline = function (t) {
            $("#chatlog")
                .append('<div class="border leave_chat_tab"><span  style="color:#16a8df"> ' + t + " đã rời khỏi </span></div>");
            try {
                var e = $(".subiz_conversionin.scroll")[0].scrollHeight;
                $(".subiz_conversion")
                    .scrollTop(e)
            } catch (t) {}
        }, t.client.chatwithus = function () {
            $(".button_chat_offline_text")
                .html("Chat với chúng tôi !")
        }, t.client.chatwithusoff = function () {
            $(".button_chat_offline_text")
                .html("Để lại tin nhắn cho chúng tôi !"), $(".text_supporter")
                .html("Offline"), $(".start_text_chat")
                .html("Nếu bạn có thắc mắc gì vui lòng để lai lời nhắn bên dưới")
        }, t.client.stophubs = function () {
            $.connection.hub.stop()
        }, $.connection.hub.start()
    		.done(function () {
    		    "ẩn danh" == nameclient && (nameclient = "ẩn danh (#" + $.connection.hub.id.substring(0, 7) + ")"), null == readCookie(Urlweb) ? (createCookie(Urlweb, $.connection.hub.id, 90), Ip = $.connection.hub.id) : Ip = readCookie(Urlweb), Currentmail = readCookie("name_sp" + Urlweb), t.server.clientconnect(nameclient, emailclinet, sdtclinet, $.connection.hub.id, IDurl, Urlweb, Ip, Iplocal, CountTime, Currentmail), $("#file-input")
    				.on("change", function () {
    				    var e = this.files;
    				    if (e && e[0])
    				        if (this.files[0].name.match(/\.(jpg|jpeg|png|pdf|docx|gif)$/)) {
    				            if (0 != (e = $("#file-input")
    									.get(0)
    									.files)
    								.length) {
    				                var n = new FormData;
    				                n.append("ImageFile", e[0]), $.ajax({
    				                    type: "Post"
    									, url: "/Home/UploadFileVisitor"
    									, data: n
    									, contentType: !1
    									, processData: !1
    									, success: function (e) {
    									    0 == e.stt ? bootbox.alert("Lỗi up file") : (t.server.messclient($.connection.hub.id, IDurl, nameclient, e.LinkFile, Ip, EmailAgent, idagent), $("#chatlog")
    											.append('<div class="border itextchat"><span  style="color:#294358"> ' + e.LinkFile + "</span></div>"))
    									}
    				                })
    				            }
    				        } else bootbox.alert("Định dạng not support"), $("#file-input")
    							.val(null)
    				}), $(".attac_smile")
    				.click(function () {
    				    $(".attac_smile")
    						.hasClass("active") ? $(".attac_smile")
    						.removeClass("active") : $(".attac_smile")
    						.addClass("active")
    				}),

                $('.option_config_sound').click(function () {
                    if ($(this).hasClass("active")) {
                        $(this).removeClass("active");
                        boolaudio = 0;
                    }
                    else {
                        $(this).addClass("active");
                        boolaudio = 1;
                    }
                })
                $(".list_icon > div ")
    				.click(function () {
    				    t.server.messclient($.connection.hub.id, IDurl, nameclient, $(this)
    							.html()
    							.trim(), Ip, EmailAgent, idagent), $("#chatlog")
    						.append('<div class="border itextchat"><span  style="color:#294358"> ' + $(this)
    							.html()
    							.trim() + "</span></div>");
    				    try {
    				        var e = $(".subiz_conversionin.scroll")[0].scrollHeight;
    				        $(".subiz_conversion")
    							.scrollTop(e)
    				    } catch (t) {}
    				}), $(".messagelog textarea")
    				.keydown(function (e) {
    				    if (13 == e.keyCode && !e.shiftKey) {
    				        var n = $("#message")
    							.val()
    							.replace(/\r?\n/g, "<br />");
    				        if (0 != $("#message")
    							.val()
    							.trim()
    							.length) {
    				            "Tư vấn trực tuyến" != $(".name_supporter")
    								.text()
    								.trim() && (EmailAgent = $(".name_supporter")
    									.text()
    									.trim()), t.server.messclient($.connection.hub.id, IDurl, nameclient, n, Ip, EmailAgent, idagent), $("#chatlog")
    								.append('<div class="border itextchat"><span  style="color:#294358"> ' + n + "</span></div>");
    				            try {
    				                var i = $(".subiz_conversionin.scroll")[0].scrollHeight;
    				                $(".subiz_conversion")
    									.scrollTop(i)
    				            } catch (t) {}
    				            $(".start_text_chat")
    								.hide()
    				        }
    				        $("#message")
    							.val("")
    							.focus(), e.preventDefault()
    				    }
    				})
    		})
    }
    var IDurl = "@ViewBag.ID"
    	, Urlweb = "@ViewBag.Urlweb"
    	, Ip = ""
    	, Iplocal = "@ViewBag.IP"
    	, nameclient = ""
    	, emailclinet = "1@gmail.com"
    	, sdtclinet = "0100"
    	, EmailAgent = ""
    	, idagent = ""
    	, CountTime = 0
        , boolaudio = 0
        , checfocus=0,
        countmess=0
    	, Currentmail = "";
    null == readCookie("time_" + Urlweb) ? (CountTime = (new Date)
    		.getTime(), createCookie("time_" + Urlweb, CountTime, .01)) : CountTime = parseInt(readCookie("time_" + Urlweb)), null == readCookie("name" + Urlweb) ? nameclient = "ẩn danh" : ($("#v_name_contact")
    		.val(readCookie("name" + Urlweb)), $(".v_name_text")
    		.html(readCookie("name" + Urlweb)), nameclient = readCookie("name" + Urlweb)), null == readCookie("mail" + Urlweb) ? emailclinet = "" : ($("#v_email_contact")
    		.val(readCookie("mail" + Urlweb)), $(".v_email_text")
    		.html(readCookie("mail" + Urlweb)), emailclinet = readCookie("mail" + Urlweb)), $(".information_user")
    	.hide(), $(window)
    	.load(function () {
    	    startChartHub(),
        

            $(".chat_information")
    			.click(function () {
    			    $(".option_form")
    					.show(), $("#option_contact_details")
    					.hide(), $("#option_contact_form")
    					.hide(), $("#option_default")
    					.show(), $("#option_edit_successful")
    					.hide()
    			}), $("#edit_contact")
    			.click(function () {
    			    0 == $(".v_name_text")
    					.text()
    					.trim()
    					.length ? ($("#option_default")
    						.hide(), $("#option_contact_details")
    						.show()) : ($("#option_default")
    						.hide(), $("#option_edit_successful")
    						.show())
    			}), $("#cancel_contact")
    			.click(function () {
    			    $(".option_form")
    					.hide()
    			}), $("#close_option")
    			.click(function () {
    			    $(".option_form")
    					.hide()
    			}), $("#option_contact_details")
    			.click(function () {
    			    $("#option_contact_details")
    					.hide(), $("#option_contact_form")
    					.show()
    			}), $("#edit_successful")
    			.click(function () {
    			    createCookie("name" + Urlweb, $("#v_name_contact")
    						.val(), 90), nameclient = $("#v_name_contact")
    					.val(), createCookie("mail" + Urlweb, $("#v_email_contact")
    						.val(), 90), emailclinet = $("#v_email_contact")
    					.val(), $(".option_form")
    					.hide()
    			}), $("#icon_edit_contact")
    			.click(function () {
    			    option_contact_details
    				, $("#option_edit_successful")
    				.hide()
    				, $("#option_contact_details")
    				.show()
    			})
    	});
    function focusout() {
        checfocus = 0;
      
        console.log(checfocus);
    }
    function focuson() {
        $('.count_messagere').hide();
        countmess = 0;
        checfocus = 1;
        console.log(checfocus);
    }
    </script>

}
<div class="chat_box_content" style="height:450px;overflow:hidden;">
    <header>

        <div class="offline_heading" style="/* display:none */">
            <label class="button_chat_offline_text"></label>

            @*<i class="fa fa-angle-up shrink_icon"></i>*@
        </div>

    </header>
    <div id="container">

        <div class="widget_online_top">
            <div class="avatar_supporter">
                <img src="https://widget-css.subiz.com/v3/img/avatar-chat.png" alt="">
            </div>
            <p>
                <font class="name_supporter">Tư vấn trực tuyến</font>
            </p>
            <p>
                <font class="text_supporter">Sẵn sàng hỗ trợ</font>
            </p>
            <p id="bl_rating" style="display: none;">
                <a href="javascript:;" id="rate_good" class="rating_button" title="Đánh giá tốt">
                    <i class="fa fa-thumbs-up rate-good"></i><font>Tốt</font>
                </a>
                <a href="javascript:;" id="rate_bad" class="rating_button" title="Đánh giá không tốt">
                    <i class="fa fa-thumbs-down rate-bad"></i>
                </a>
            </p>
            <div class="logo_company" style="display:none">
                <img alt="">
            </div>
        </div>
        <div class="subiz_conversion">
            <div class="subiz_conversionin scroll">
                <div style="padding-top:10px" class="message_welcome">
                    <div id="chatlog">
                        <div class="start_text_chat">Bạn có thắc mắc? Hãy chat với chúng tôi!</div>
                        <div class="count_messagere"> </div>
                    </div>
                </div>
            </div>

            <div class="text_notice" style="display:none">{agent} đang trả lời...</div>
        </div>

        @*<div id="onlineusers">
                <b>Online Users</b>
            </div>*@
        <div id="chatarea">
            <div class="messagelog">
                <textarea placeholder="Nhập nội dung và ấn  'Enter' để chat" spellcheck="true" id="message" class="messagebox" onfocusout="focusout();" onfocus="focuson();"></textarea>
            </div>

        </div>
        <div id="tab_chat_service">
            <div id="attach_file_">

                <label for="file-input" class="input-label">
                    <i class="fa fa-paperclip" aria-hidden="true" style="margin-left:10px;cursor:pointer"></i>
                    <input type="file" id="file-input" accept="jpg gif jpeg png bmp docx pdf">
                </label>
            </div>
            <div class="attac_smile">
                <i class="fa fa-smile-o" aria-hidden="true"></i>
                <div class="list_icon">
                    <div class="icon_smile_1"><img src="~/Content/iconchat/adore.gif" /></div>
                    <div class="icon_smile_2"> <img src="~/Content/iconchat/choler.gif" /></div>
                    <div class="icon_smile_3">
                        <img src="~/Content/iconchat/Confused.gif" /></div>
                    <div class="icon_smile_4">
                        <img src="~/Content/iconchat/cry.gif" /></div>
                    <div class="icon_smile_5">
                        <img src="~/Content/iconchat/feel_good.gif" /></div>
                    <div class="icon_smile_6">
                        <img src="~/Content/iconchat/oh.gif" /></div>
                    <div class="icon_smile_7">
                        <img src="~/Content/iconchat/ops.gif" /></div>
                    <div class="icon_smile_8">
                        <img src="~/Content/iconchat/Shoked.gif" /></div>
                    <div class="icon_smile_9">
                        <img src="~/Content/iconchat/still_dreaming.gif" /></div>
                </div>
            </div>
        </div>
        <div id="tab_chat_bot">
            <button class="chat_information">Cài đặt</button>
        </div>
        <span class="option_form" style="display: none;">
            <i id="close_option" class="fa fa-remove icon_close"></i>
            <span id="option_default" style="display: inline;">
                <span class="option_config_sound">
                    <label class="nameconfig">Âm thanh</label>
                    <i class="fa fa-volume-off icon_sound_off" aria-hidden="true"></i>
                    <i class="fa fa-volume-up icon_sound">
                        
                        <span class="fa fa-remove" style="display:none"></span>
                    </i>
                </span>
                <span class="option_config_line" style="display: none;">
                    <a href="javascript:;" id="email_transcript">Email transcript</a>
                    <i class="fa fa-envelope"></i>
                </span>
                <span class="option_config_line">
                    <span id="edit_contact">Thông tin cá nhân</span>
                    <i class="fa fa-info"></i>
                </span>
                <span class="option_config_line" style="display: none;">
                    <a id="btn_endchat" class="btn_endchat color_theme_default" href="javascript:;">Kết thúc chat</a>
                </span>
            </span>
            <span id="option_contact_details" style="display: none;">
                <span class="option_config_line">
                    <a class="login_facebook"><fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
</fb:login-button></a>
                </span>
                <span class="option_config_line">
                    <a class="login_google"> <span class="g-signin2" data-onsuccess="onSignIn"></span></a>
                </span>
                <span class="option_config_line">
                    <a id="edit_contact_details">Tên và Email</a>
                </span>
            </span>
            <span id="option_contact_form" style="display: none;">
                <span class="option_config_line"><label>Sửa thông tin</label></span>
                <span class="option_config_line">
                    <input type="text" placeholder="Họ tên" id="v_name_contact" class="text v_name" maxlength="100">
                </span>
                <span class="option_config_line">
                    <input type="text" placeholder="Địa chỉ email" id="v_email_contact" class="text v_email" maxlength="100">
                </span>
                <span class="option_config_line">
                    <a href="javascript:;" class="btn_endchat_small color_theme_default" id="edit_successful">Lưu</a> hoặc <a href="javascript:;" id="cancel_contact">Hủy</a>
                </span>
            </span>
            <span id="option_email_transcript" style="display: none;">
                <span class="option_config_line">
                    <label>Gửi transcript qua email</label>
                </span>
                <span class="option_config_line">
                    <input type="text" placeholder="vistor@example.com" id="v_email_transcript" class="text v_email" maxlength="100">
                </span>
                <span class="option_config_line">
                    <a href="javascript:;" class="btn_endchat_small color_theme_default" id="save_email_transcript">Gửi</a> hoặc <a href="javascript:;" id="cancel_email_transcript">Hủy</a>
                </span>
            </span>

            <span id="option_edit_successful" style="display: none;">
                <span class="config_complete">
                    <strong class="v_name_text"></strong><br>
                    <font class="v_email_text"></font>
                    <a><i id="icon_edit_contact" class="fa fa-pencil icon_edit"></i></a>
                </span>
            </span>
        </span>
    </div>
                    @*<input id="inputname" type="text" width="40px" height="100px" />*@
    <div class="information_user">
        <input type="text" id="nickname" placeholder="Mời bạn nhập Tên" width="40px" height="100px" />
        <input type="text" id="email_clinet" placeholder="Mời bạn nhập Email" width="40px" height="100px" />
        <div class="login_social_network">
            <span>Đăng nhập bằng</span>
        </div>
        <button type="submit" id="btsmt" value="name">Bat dau chat</button>
    </div>
</div>
